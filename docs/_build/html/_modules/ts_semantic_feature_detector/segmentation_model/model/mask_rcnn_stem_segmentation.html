<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation &mdash; ts_semantic_feature_detector 0.0.1 documentation</title>
      <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <script data-url_root="../../../../" id="documentation_options" src="../../../../_static/documentation_options.js"></script>
        <script src="../../../../_static/doctools.js"></script>
        <script src="../../../../_static/sphinx_highlight.js"></script>
    <script src="../../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../../genindex.html" />
    <link rel="search" title="Search" href="../../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../../index.html" class="icon icon-home">
            ts_semantic_feature_detector
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../modules.html">ts_semantic_feature_detector</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../../index.html">ts_semantic_feature_detector</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implements the Mask RCNN model to do stem mask segmentation.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Dict</span><span class="p">,</span> <span class="n">Any</span>

<span class="kn">import</span> <span class="nn">numpy.typing</span> <span class="k">as</span> <span class="nn">npt</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">from</span> <span class="nn">torchvision.models.detection.faster_rcnn</span> <span class="kn">import</span> <span class="n">FastRCNNPredictor</span>
<span class="kn">from</span> <span class="nn">torchvision.models.detection.mask_rcnn</span> <span class="kn">import</span> <span class="n">MaskRCNN</span><span class="p">,</span> <span class="n">MaskRCNNPredictor</span><span class="p">,</span> <span class="n">maskrcnn_resnet50_fpn_v2</span> 
<span class="kn">from</span> <span class="nn">torchvision.transforms</span> <span class="kn">import</span> <span class="n">PILToTensor</span>

<span class="kn">from</span> <span class="nn">ts_semantic_feature_detector.segmentation_model.model.detection</span> <span class="kn">import</span> <span class="n">transforms</span> <span class="k">as</span> <span class="n">T</span>
<span class="kn">from</span> <span class="nn">ts_semantic_feature_detector.segmentation_model.model.detection.engine</span> <span class="kn">import</span> <span class="n">train_one_epoch</span><span class="p">,</span> <span class="n">evaluate</span>
<span class="kn">from</span> <span class="nn">ts_semantic_feature_detector.segmentation_model.model.detection.utils</span> <span class="kn">import</span> <span class="n">collate_fn</span>
<span class="kn">from</span> <span class="nn">ts_semantic_feature_detector.segmentation_model.ts_dataset</span> <span class="kn">import</span> <span class="n">ts_load_dataset</span>

<div class="viewcode-block" id="MaskRCNNStemSegmentationModel"><a class="viewcode-back" href="../../../../ts_semantic_feature_detector.segmentation_model.model.html#ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation.MaskRCNNStemSegmentationModel">[docs]</a><span class="k">class</span> <span class="nc">MaskRCNNStemSegmentationModel</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Implements the Mask RCNN model to do stem mask segmentation.</span>

<span class="sd">    Uses the Improved Mask R-CNN model with a ResNet-50-FPN backbone </span>
<span class="sd">    from the &#39;Benchmarking Detection Transfer Learning with Vision </span>
<span class="sd">    Transformers&#39; &lt;https://arxiv.org/abs/2111.11429&gt; paper, implemented</span>
<span class="sd">    in the PyTorch framework. Versions: torch (1.13.1) and torchvision</span>
<span class="sd">    (0.14.1).</span>

<span class="sd">    It makes the necessary adaptations to the existing model to change</span>
<span class="sd">    the number of classes predicted (in this case, we are interested in</span>
<span class="sd">    only one class: the stems). It also implements a training and</span>
<span class="sd">    a inference methods to allow easy use.</span>

<span class="sd">    TODO: Remove TerraSentiaDataset object requirement to do inference.</span>
<span class="sd">        Create another structure to encapsulate information about the images. </span>
<span class="sd">    TODO: Add more explanation about train_log and validation_log dictionaries.</span>
<span class="sd">    TODO: Encapsule some of train method routines in private functions.</span>
<span class="sd">    </span>
<span class="sd">    Attributes:</span>
<span class="sd">        hyperparams (a dict [str, float]): the hyperparameters values. More</span>
<span class="sd">            description can be found at the constructor method documentation.</span>
<span class="sd">        dataset (:obj:`segmentation_model.ts_dataset.ts_load_dataset.TerraSentiaDataset`): </span>
<span class="sd">            The TerraSentiaDataset object. It contains all images path and</span>
<span class="sd">            do all the pre-processing needed. It also contains some information</span>
<span class="sd">            about the images, as original size, mean and standard deviation.</span>
<span class="sd">        model (:obj:`torchvision.models.detection.mask_rcnn.MaskRCNN`):</span>
<span class="sd">            The Mask RCNN model customized to the stem segmentation task.</span>
<span class="sd">        optimizer: the SGD optimizer for training the model</span>
<span class="sd">        lr_scheduler: the LR Scheduler for training the model.</span>
<span class="sd">        transforms: a list of PyTorch transforms to be applied to images when loaded.</span>
<span class="sd">        train_log: a dictionary containing all the training metrics.</span>
<span class="sd">        validation_log: a dictionary containing all the validation metrics.</span>
<span class="sd">        last_best_mAP: the last best Average Precision calculated during training.</span>
<span class="sd">            It measures how well the model performed at validation set.</span>
<span class="sd">        start_epoch: the epoch that the model stopped training.</span>
<span class="sd">        train_log: a dictionary containing training metrics data.</span>
<span class="sd">        validation_log: a dictionary containing validation metrics data.</span>
<span class="sd">        train_dataset_idxs: a list containing the training dataset images.</span>
<span class="sd">        validation_dataset_idxs: a list containing the validation dataset images.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ts_dataset</span><span class="p">:</span> <span class="n">ts_load_dataset</span><span class="o">.</span><span class="n">TerraSentiaDataset</span><span class="p">,</span>
        <span class="n">input_min_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">input_max_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">transforms</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">train</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes the model with the necessary modifications.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts_dataset: TerraSentiaDataset object. It is needed for training</span>
<span class="sd">                and inference. It encapsules all the data for training and</span>
<span class="sd">                has essential information about the images for inference.</span>
<span class="sd">            input_min_size: The minimum size to resize image before inserting it</span>
<span class="sd">                into the model.</span>
<span class="sd">            input_max_size: The maximum size to resize image before inserting it</span>
<span class="sd">                into the model.</span>
<span class="sd">            transforms: a list of PyTorch transforms to be applied to images when loaded.</span>
<span class="sd">                If transforms is not None, it will be set for training or inference</span>
<span class="sd">                depending on model_path value.</span>
<span class="sd">            model_path: a string containing the path to the trained model. If it is None,</span>
<span class="sd">                transforms attribute is evaluated for training. If it is not None, the</span>
<span class="sd">                transforms attribute is evaluated for inference.</span>
<span class="sd">            train: a boolean value indicating if the user wants to train the network.</span>

<span class="sd">        **kwargs:</span>
<span class="sd">            lr: the SGD optimizer learning rate. Default = 0.005</span>
<span class="sd">            momentum: the SGD optimizer momentum. Default = 0.9 </span>
<span class="sd">            weight_decay: the SGD optimizer weight decay. Default = 0.0005</span>
<span class="sd">            step_size: the amount of epochs to apply learning rate decay. Default = 30</span>
<span class="sd">            gamma: the learning decay rate. Default = 0.1</span>
<span class="sd">            checkpoint_epochs: the number of epochs between safety model saves. Default = 20</span>
<span class="sd">            checkpoint_mAP_threshold: the minimum mAP improvement to save a new model.</span>
<span class="sd">                Default = 0.01</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;lr&#39;</span><span class="p">:</span> <span class="mf">0.005</span><span class="p">,</span>
            <span class="s1">&#39;momentum&#39;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
            <span class="s1">&#39;weight_decay&#39;</span><span class="p">:</span> <span class="mf">0.0005</span><span class="p">,</span>
            <span class="s1">&#39;step_size&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;gamma&#39;</span><span class="p">:</span> <span class="mf">0.1</span><span class="p">,</span>
            <span class="s1">&#39;checkpoint_epochs&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>
            <span class="s1">&#39;checkpoint_mAP_threshold&#39;</span><span class="p">:</span> <span class="mf">0.01</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span> <span class="o">=</span> <span class="n">ts_dataset</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_model</span><span class="p">(</span>
            <span class="n">input_min_size</span><span class="p">,</span>
            <span class="n">input_max_size</span><span class="p">,</span> 
            <span class="n">model_path</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transforms</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="n">transforms</span>
        <span class="k">elif</span> <span class="n">train</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_transforms</span><span class="p">(</span><span class="n">training</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">transforms</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_transforms</span><span class="p">(</span><span class="n">training</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<div class="viewcode-block" id="MaskRCNNStemSegmentationModel._get_model"><a class="viewcode-back" href="../../../../ts_semantic_feature_detector.segmentation_model.model.html#ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation.MaskRCNNStemSegmentationModel._get_model">[docs]</a>    <span class="k">def</span> <span class="nf">_get_model</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">input_min_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">input_max_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">model_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_classes</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">MaskRCNN</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Constructs the model from PyTorch and adapt to stem segmentation task.</span>

<span class="sd">        It also constructs a SGD optimizer and a learning rate scheduler.</span>
<span class="sd">        </span>
<span class="sd">        Args:</span>
<span class="sd">            input_min_size: The minimum size to resize image before inserting it</span>
<span class="sd">                into the model.</span>
<span class="sd">            input_max_size: The maximum size to resize image before inserting it</span>
<span class="sd">                into the model.</span>
<span class="sd">            model_path: a string containing the path to the trained model. If</span>
<span class="sd">                specified, model weights are loaded.</span>
<span class="sd">            num_classes: The number of classes that the model will look for.</span>
<span class="sd">                For this task, num_classes should be 2 (stem and background).</span>
<span class="sd">                This value is used as default.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the MaskRCNN model, the SGD optimizer and the LR Scheduler, respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">maskrcnn_resnet50_fpn_v2</span><span class="p">(</span>
            <span class="n">weights</span><span class="o">=</span><span class="s2">&quot;DEFAULT&quot;</span><span class="p">,</span> 
            <span class="n">min_size</span><span class="o">=</span><span class="n">input_min_size</span><span class="p">,</span> 
            <span class="n">max_size</span><span class="o">=</span><span class="n">input_max_size</span><span class="p">,</span> 
            <span class="n">image_mean</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> 
            <span class="n">image_std</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">std_dev</span><span class="p">)</span>
        <span class="n">in_features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span><span class="o">.</span><span class="n">cls_score</span><span class="o">.</span><span class="n">in_features</span>
        
        <span class="c1"># Replace the pre-trained head with a new one</span>
        <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">box_predictor</span> <span class="o">=</span> <span class="n">FastRCNNPredictor</span><span class="p">(</span>
            <span class="n">in_features</span><span class="p">,</span> 
            <span class="n">num_classes</span><span class="p">)</span>

        <span class="c1"># Get the number of input features for the mask classifier</span>
        <span class="n">in_features_mask</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">mask_predictor</span><span class="o">.</span><span class="n">conv5_mask</span><span class="o">.</span><span class="n">in_channels</span>
        <span class="n">hidden_layer</span> <span class="o">=</span> <span class="mi">256</span>

        <span class="c1"># Replace the mask predictor with a new one</span>
        <span class="n">model</span><span class="o">.</span><span class="n">roi_heads</span><span class="o">.</span><span class="n">mask_predictor</span> <span class="o">=</span> <span class="n">MaskRCNNPredictor</span><span class="p">(</span>
            <span class="n">in_features_mask</span><span class="p">,</span>
            <span class="n">hidden_layer</span><span class="p">,</span>
            <span class="n">num_classes</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span> <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">()</span> <span class="k">else</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s1">&#39;cpu&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using device: &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">parameters</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">requires_grad</span><span class="p">]</span>
        <span class="n">optimizer</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">SGD</span><span class="p">(</span>
            <span class="n">params</span><span class="p">,</span>
            <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;lr&#39;</span><span class="p">],</span> 
            <span class="n">momentum</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;momentum&#39;</span><span class="p">],</span> 
            <span class="n">weight_decay</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;weight_decay&#39;</span><span class="p">])</span>
        
        <span class="n">lr_scheduler</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">optim</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">StepLR</span><span class="p">(</span>
            <span class="n">optimizer</span><span class="p">,</span>
            <span class="n">step_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;step_size&#39;</span><span class="p">],</span>
            <span class="n">gamma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;gamma&#39;</span><span class="p">])</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">last_best_mAP</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_epoch</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_log</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_log</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset_idxs</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset_idxs</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">model_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">checkpoint</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
            <span class="c1"># To continue training, we need to start from the next epoch (+1)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_epoch</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;epoch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;model_state_dict&#39;</span><span class="p">])</span>
            <span class="n">optimizer</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_best_mAP</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;mAP&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_log</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;train_log&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_log</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;validation_log&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset_idxs</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;train_dataset_idxs&#39;</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset_idxs</span> <span class="o">=</span> <span class="n">checkpoint</span><span class="p">[</span><span class="s1">&#39;validation_dataset_idxs&#39;</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">model</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">lr_scheduler</span></div>
    
<div class="viewcode-block" id="MaskRCNNStemSegmentationModel._get_transforms"><a class="viewcode-back" href="../../../../ts_semantic_feature_detector.segmentation_model.model.html#ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation.MaskRCNNStemSegmentationModel._get_transforms">[docs]</a>    <span class="k">def</span> <span class="nf">_get_transforms</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">training</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns standard PyTorch transforms composed for the mask segmentation task.</span>

<span class="sd">        Args:</span>
<span class="sd">            training: boolean value that indicates if the model will be used</span>
<span class="sd">                for training.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">PILToTensor</span><span class="p">())</span>
        <span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">ConvertImageDtype</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">float</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">training</span><span class="p">:</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">RandomHorizontalFlip</span><span class="p">())</span>
            <span class="n">transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">T</span><span class="o">.</span><span class="n">RandomPhotometricDistort</span><span class="p">())</span>

        <span class="k">return</span> <span class="n">T</span><span class="o">.</span><span class="n">Compose</span><span class="p">(</span><span class="n">transforms</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="MaskRCNNStemSegmentationModel._log_to_file"><a class="viewcode-back" href="../../../../ts_semantic_feature_detector.segmentation_model.model.html#ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation.MaskRCNNStemSegmentationModel._log_to_file">[docs]</a>    <span class="k">def</span> <span class="nf">_log_to_file</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span>
            <span class="n">path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
            <span class="n">data</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span>
        <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Write a file with desired data.</span>

<span class="sd">        #TODO: create the folder if it not exist</span>

<span class="sd">        Args:</span>
<span class="sd">            path: The path where it is desired to write the log.</span>
<span class="sd">            data: a list or a dictionary with the data to be logged.</span>
<span class="sd">                If a dictionary is passed, it dumps into the file </span>
<span class="sd">                in a json format. If a list is passed, it writes</span>
<span class="sd">                every position in a new line.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MaskRCNNStemSegmentationModel._divide_dataset"><a class="viewcode-back" href="../../../../ts_semantic_feature_detector.segmentation_model.model.html#ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation.MaskRCNNStemSegmentationModel._divide_dataset">[docs]</a>    <span class="k">def</span> <span class="nf">_divide_dataset</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> 
        <span class="n">train_percentage</span><span class="p">:</span> <span class="nb">float</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Divide the dataset into training and validation subsets.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_percentage: the percentage of all the dataset that will be used</span>
<span class="sd">                as training images. The remaining portion will be used to evaluate</span>
<span class="sd">                the model during training.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The training and validation subsets, respectivaly. Both are lists with</span>
<span class="sd">                the indices that represent their position at the</span>
<span class="sd">                ts_load_dataset.TerraSentiaDataset list of images.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">train_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">train_percentage</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_imgs</span><span class="p">)</span>
        <span class="n">test_size</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">num_imgs</span> <span class="o">-</span> <span class="n">train_size</span>
        <span class="n">training_dataset</span><span class="p">,</span> <span class="n">validation_dataset</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">random_split</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="p">,</span>
            <span class="p">[</span><span class="n">train_size</span><span class="p">,</span> <span class="n">test_size</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">training_dataset</span><span class="p">,</span> <span class="n">validation_dataset</span></div>

<div class="viewcode-block" id="MaskRCNNStemSegmentationModel.train"><a class="viewcode-back" href="../../../../ts_semantic_feature_detector.segmentation_model.model.html#ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation.MaskRCNNStemSegmentationModel.train">[docs]</a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">train_percentage</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">training_batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">validation_batch_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">num_epochs</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">log_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">num_workers</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Train the model and log data when needed.</span>

<span class="sd">        Args:</span>
<span class="sd">            train_percentage: the percentage of all the dataset that will be used</span>
<span class="sd">                as training images. The remaining portion will be used to evaluate</span>
<span class="sd">                the model during training.</span>
<span class="sd">            training_batch_size: the size of the batch size during training.</span>
<span class="sd">            validation_batch_size: the size of the batch size during validation.</span>
<span class="sd">            num_epochs: number of epochs for the training.</span>
<span class="sd">            log_path: the path to the folder where the logs will be written. If None,</span>
<span class="sd">                logging is deactivated.</span>
<span class="sd">            num_workers: the number of sub-processes to use for data loading.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset_idxs</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset_idxs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset_idxs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset_idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_divide_dataset</span><span class="p">(</span><span class="n">train_percentage</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_file</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">&#39;train_imgs.log&#39;</span><span class="p">),</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">png_imgs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset_idxs</span><span class="o">.</span><span class="n">indices</span><span class="p">],</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_file</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">&#39;validation_imgs.log&#39;</span><span class="p">),</span>
                <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dataset</span><span class="o">.</span><span class="n">png_imgs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset_idxs</span><span class="o">.</span><span class="n">indices</span><span class="p">],</span>
            <span class="p">)</span>

        <span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset_idxs</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">training_batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">)</span>
        
        <span class="n">validation_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset_idxs</span><span class="p">,</span>
            <span class="n">batch_size</span><span class="o">=</span><span class="n">validation_batch_size</span><span class="p">,</span>
            <span class="n">shuffle</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">num_workers</span><span class="o">=</span><span class="n">num_workers</span><span class="p">,</span>
            <span class="n">collate_fn</span><span class="o">=</span><span class="n">collate_fn</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">start_epoch</span><span class="p">,</span> <span class="n">num_epochs</span><span class="p">):</span>
            <span class="n">train_logger</span> <span class="o">=</span> <span class="n">train_one_epoch</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="p">,</span>
                <span class="n">train_loader</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span>
                <span class="n">epoch</span><span class="p">,</span>
                <span class="n">print_freq</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lr_scheduler</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>

            <span class="n">test_logger</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span>
                <span class="n">validation_loader</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>

            <span class="c1"># Getting training metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">train_log</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">train_logger</span><span class="o">.</span><span class="n">meters</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">meter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_log</span><span class="p">[</span><span class="n">epoch</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">train_log</span><span class="p">[</span><span class="n">epoch</span><span class="p">][</span><span class="n">meter</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_log</span><span class="p">[</span><span class="n">epoch</span><span class="p">][</span><span class="n">meter</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
            
            <span class="c1"># Getting evaluation metrics</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_log</span><span class="p">[</span><span class="n">epoch</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_log</span><span class="p">[</span><span class="n">epoch</span><span class="p">][</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_logger</span><span class="o">.</span><span class="n">coco_eval</span><span class="p">[</span><span class="s1">&#39;bbox&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">validation_log</span><span class="p">[</span><span class="n">epoch</span><span class="p">][</span><span class="s1">&#39;segm&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">test_logger</span><span class="o">.</span><span class="n">coco_eval</span><span class="p">[</span><span class="s1">&#39;segm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">)</span>
            <span class="n">mAP</span> <span class="o">=</span> <span class="n">test_logger</span><span class="o">.</span><span class="n">coco_eval</span><span class="p">[</span><span class="s1">&#39;segm&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            
            <span class="n">save_data</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;epoch&#39;</span><span class="p">:</span> <span class="n">epoch</span><span class="p">,</span>
                <span class="s1">&#39;model_state_dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                <span class="s1">&#39;optimizer_state_dict&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimizer</span><span class="o">.</span><span class="n">state_dict</span><span class="p">(),</span>
                <span class="s1">&#39;mAP&#39;</span><span class="p">:</span> <span class="n">mAP</span><span class="p">,</span>
                <span class="s1">&#39;train_log&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_log</span><span class="p">,</span>
                <span class="s1">&#39;validation_log&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_log</span><span class="p">,</span>
                <span class="s1">&#39;train_dataset_idxs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">train_dataset_idxs</span><span class="p">,</span>
                <span class="s1">&#39;validation_dataset_idxs&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">validation_dataset_idxs</span>
            <span class="p">}</span>

            <span class="c1"># Save a checkpoint if the model improves by &quot;checkpoint_mAP&quot; or each &quot;checkpoint_epochs&quot; epochs.</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">mAP</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;checkpoint_mAP_threshold&#39;</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_best_mAP</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_data</span><span class="p">,</span> <span class="s2">&quot;models/model_better_mAP_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">last_best_mAP</span> <span class="o">=</span> <span class="n">mAP</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">epoch</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hyperparams</span><span class="p">[</span><span class="s1">&#39;checkpoint_epochs&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">torch</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_data</span><span class="p">,</span> <span class="s2">&quot;models/model_safety_checkpoint_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">epoch</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">log_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_file</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">&#39;train_log.json&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">train_log</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_log_to_file</span><span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">&#39;validation_log.json&#39;</span><span class="p">),</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">validation_log</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Finished training!&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="MaskRCNNStemSegmentationModel.inference"><a class="viewcode-back" href="../../../../ts_semantic_feature_detector.segmentation_model.model.html#ts_semantic_feature_detector.segmentation_model.model.mask_rcnn_stem_segmentation.MaskRCNNStemSegmentationModel.inference">[docs]</a>    <span class="k">def</span> <span class="nf">inference</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">inference_img</span><span class="p">:</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">inference_img_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Image</span><span class="o">.</span><span class="n">Image</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">npt</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Passes a image through the network and outputs the result.</span>

<span class="sd">        The result is filtered by project convenience, therefore some</span>
<span class="sd">        network outputs are inaccessible using this method.</span>

<span class="sd">        TODO: incorporate the same transformation object from the dataset.</span>

<span class="sd">        Args:</span>
<span class="sd">            inference_img: a Numpy array containing the image. If it is not</span>
<span class="sd">                provided, the path to the image must be informed.</span>
<span class="sd">            inference_img_path: the path to the image. If it is not provided,</span>
<span class="sd">                the path to the image must be informed.</span>

<span class="sd">        Returns:</span>
<span class="sd">            the RGB image (PIL image class) and</span>
<span class="sd">            a tuple of three Numpy arrays: the bounding boxes, </span>
<span class="sd">            the mask images and the scores for each one of </span>
<span class="sd">            the detected instances, respectively.</span>
<span class="sd">        &quot;&quot;&quot;</span> 
        <span class="n">img</span> <span class="o">=</span> <span class="kc">None</span>   
        <span class="k">if</span> <span class="n">inference_img</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">fromarray</span><span class="p">(</span><span class="n">inference_img</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">inference_img_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">inference_img_path</span><span class="p">)</span><span class="o">.</span><span class="n">convert</span><span class="p">(</span><span class="s2">&quot;RGB&quot;</span><span class="p">)</span>

        <span class="n">img_tensor</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
            <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">PILToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span><span class="o">/</span><span class="mi">255</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">img_tensor</span> <span class="o">=</span> <span class="n">PILToTensor</span><span class="p">()(</span><span class="n">img</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze_</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="mi">255</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="n">img_tensor</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
        
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">img_tensor</span><span class="p">)</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;boxes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;masks&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scores&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">detach</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">img</span><span class="p">,</span> <span class="n">boxes</span><span class="p">,</span> <span class="n">masks</span><span class="p">,</span> <span class="n">scores</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Lucas Toschi.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>